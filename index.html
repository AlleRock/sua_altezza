<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sua Altezza V51 - Enterprise Edition</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&family=Barlow+Condensed:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { 
            --gold: #f1c40f; 
            --bg: #0b0f1a; 
            --card-bg: rgba(0, 0, 0, 0.7); 
            --danger: #ff4757; 
            --success: #2ecc71; 
            --tab-bg: #161b2a; 
            --text: #ffffff; 
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            height: 100vh; 
        }
        
        /* Splash Screen ottimizzato */
        #splash-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #0b0f1a; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 9999; 
            transition: opacity 0.8s ease, visibility 0.8s; 
        }
        
        .page { display: none; height: calc(100vh - 75px); width: 100%; padding: 10px; box-sizing: border-box; overflow-y: auto; }
        .page.active { display: block; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .card { background: var(--card-bg); border: 1px solid var(--gold); border-radius: 12px; padding: 12px; text-align: center; }
        .card-label { font-size: 0.75rem; color: #cbd5e1; text-transform: uppercase; font-weight: 800; margin-bottom: 4px; }
        .value { font-family: 'Barlow Condensed'; font-size: 2.4rem; font-weight: 900; color: var(--gold); line-height: 1; }
        
        .chart-container { background: rgba(0,0,0,0.6); border-radius: 15px; padding: 12px; height: 180px; margin: 10px 0; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        
        .compass-row { display: flex; align-items: center; justify-content: space-around; margin: 15px 0; background: rgba(255,255,255,0.03); border-radius: 20px; padding: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .compass-area { position: relative; width: 130px; height: 130px; }
        .compass-housing { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--gold); box-sizing: border-box; box-shadow: 0 0 15px rgba(241,196,15,0.2); }
        #compass-rose { width: 100%; height: 100%; transition: transform 0.1s linear; }
        
        #degrees { font-family: 'Barlow Condensed'; font-size: 3.5rem; font-weight: 900; color: var(--gold); line-height: 1; }
        
        #toolbox-panel { position: fixed; bottom: 85px; left: 10px; right: 10px; background: var(--tab-bg); border: 2px solid var(--gold); border-radius: 20px; padding: 20px; display: none; z-index: 3000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        button { font-family: 'Inter'; font-weight: 800; border-radius: 12px; border: none; text-transform: uppercase; padding: 15px; margin-bottom: 10px; font-size: 0.85rem; width: 100%; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-sensor { background: var(--gold); color: #000; }
        .btn-white { background: #fff; color: #000; }
        
        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--tab-bg); display: flex; align-items: center; z-index: 2000; border-top: 1px solid rgba(255,255,255,0.1); }
        .tab-item { text-align: center; color: #64748b; flex: 1; font-size: 0.7rem; font-weight: 800; cursor: pointer; }
        .tab-item.active { color: var(--gold); }
        .tab-item span { font-size: 1.8rem; display: block; margin-bottom: 2px; }
        
        #map { height: 100%; width: 100%; background: #000; }
        
        .map-overlay-btn { position: absolute; right: 15px; background: white; border-radius: 10px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 1000; border: none; color: black; }
        #btn-recenter { top: 80px; }

        .user-marker-icon { display: flex; align-items: center; justify-content: center; transition: transform 0.1s linear; }
    </style>
</head>
<body>

    <div id="splash-screen" role="presentation">
        <h1 style="color:var(--gold); font-weight:900; margin:0; font-size:3rem; letter-spacing:-1px;">SUA ALTEZZA</h1>
        <div style="color:#64748b; letter-spacing:4px; font-size:0.8rem; margin-top:5px; font-weight:700;">NAVIGAZIONE ALTIMETRICA</div>
        <div style="margin-top:80px; color:rgba(255,255,255,0.3); font-size:0.75rem;">Engineered by <b>Mem Software</b></div>
    </div>

    <div id="page-dash" class="page active">
        <div class="stats-grid">
            <div class="card"><div class="card-label">Quota Attuale</div><div id="dash-alt" class="value">--</div></div>
            <div class="card"><div class="card-label">Pendenza</div><div id="dash-slope" class="value">0%</div></div>
        </div>
        <div class="stats-grid">
            <div class="card" style="border-color: var(--success)"><div class="card-label">D+ Accumulato</div><div id="dash-up-done" class="value" style="color:var(--success)">0</div></div>
            <div class="card" style="border-color: var(--danger)"><div class="card-label">D+ Mancante</div><div id="dash-up-todo" class="value" style="color:var(--danger)">--</div></div>
        </div>
        
        <div class="chart-container">
            <canvas id="altChart"></canvas>
        </div>

        <div class="stats-grid">
            <div class="card"><div class="card-label">Distanza Km</div><div id="dash-done" class="value">0.0</div></div>
            <div class="card"><div class="card-label">Residuo Km</div><div id="dash-todo" class="value">--</div></div>
        </div>

        <div class="compass-row">
            <div class="compass-area">
                <div class="compass-housing"></div>
                <svg id="compass-rose" viewBox="0 0 200 200" aria-hidden="true">
                    <circle cx="100" cy="100" r="95" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
                    <text x="100" y="35" fill="#f1c40f" font-family="Barlow Condensed" font-size="40" text-anchor="middle" font-weight="900">N</text>
                    <text x="100" y="185" fill="white" font-size="20" text-anchor="middle">S</text>
                    <text x="175" y="110" fill="white" font-size="20" text-anchor="middle">E</text>
                    <text x="25" y="110" fill="white" font-size="20" text-anchor="middle">O</text>
                </svg>
            </div>
            <div style="text-align:center">
                <div id="degrees">0¬∞</div>
                <button class="btn-sensor" onclick="sensors.requestPermissions()" style="width:auto; padding:8px 15px; font-size:0.65rem;">CALIBRA BUSSOLA</button>
            </div>
        </div>
        <button class="btn-white" onclick="ui.toggleToolbox()" style="border: 2px solid var(--gold);">üß∞ TOOLBOX STRUMENTI</button>
    </div>

    <div id="page-map" class="page" style="padding:0; position:relative;">
        <div id="map"></div>
        <button id="btn-recenter" class="map-overlay-btn" aria-label="Ricentra posizione">üéØ</button>
        <div style="position:absolute; bottom:20px; left:10px; right:10px; display:none; gap:10px; z-index:2000;" id="editor-controls">
            <button class="btn-white" style="flex:1" onclick="editor.undo()">ANNULLA</button>
            <button style="background:var(--success); color:black; flex:2" onclick="editor.save()">SALVA PERCORSO</button>
        </div>
    </div>

    <div id="page-meteo" class="page">
        <div style="text-align:center; margin-top:50px;">
            <div class="card-label" style="font-size:1.2rem;">Pressione Barometrica</div>
            <div id="baro-val" style="font-size:5.5rem; font-weight:900; color:var(--success); font-family:'Barlow Condensed';">---</div>
            <div id="baro-status" style="color:#64748b; font-size: 1.2rem;">hPa (mbar)</div>
            <p id="baro-error" style="color:var(--danger); display:none; margin-top:20px;">Sensore barometrico non rilevato sul dispositivo.</p>
        </div>
    </div>

    <div id="toolbox-panel">
        <button style="background:var(--success); color:black;" onclick="editor.start()">‚úçÔ∏è DISEGNA NUOVO PERCORSO</button>
        <button style="background:var(--danger); color:white;" onclick="geo.sendSOS()">üö® SOS COORDINATE</button>
        <button class="btn-white" onclick="document.getElementById('gpx-input').click()">üó∫Ô∏è IMPORTA GPX</button>
        <button class="btn-white" style="background:#333; color:white;" onclick="storage.fullReset()">üóëÔ∏è RESET TOTALE DATI</button>
        <button class="btn-white" onclick="ui.toggleToolbox()">CHIUDI</button>
        <input type="file" id="gpx-input" style="display:none" onchange="editor.handleFileUpload(event)">
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" id="tab-dash" onclick="ui.switchPage('dash')"><span>üìä</span>DASHBOARD</div>
        <div class="tab-item" id="tab-map" onclick="ui.switchPage('map')"><span>üó∫Ô∏è</span>MAPPA</div>
        <div class="tab-item" id="tab-meteo" onclick="ui.switchPage('meteo')"><span>‚òÅÔ∏è</span>BAROMETRO</div>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
    /**
     * ARCHITETTURA "SUA ALTEZZA V51"
     * Organizzazione modulare per massima manutenibilit√†
     */

    // --- CONFIGURAZIONE E STATO ---
    const APP_STATE = {
        history: [],        // JSON: {lat, lng, alt}
        routePoints: [],    // JSON: punti del percorso caricato
        heading: 0,
        isEditing: false,
        lastPos: null
    };

    // --- MODULO STORAGE (Solo JSON) ---
    const storage = {
        save(key, data) { localStorage.setItem(key, JSON.stringify(data)); },
        load(key) { 
            const data = localStorage.getItem(key);
            try { return data ? JSON.parse(data) : null; } catch(e) { return null; }
        },
        fullReset() { 
            if(confirm("Attenzione: questo eliminer√† tutti i dati salvati e i percorsi. Procedere?")) {
                localStorage.clear(); 
                location.reload(); 
            }
        }
    };

    // --- MODULO GEOLOCALIZZAZIONE ---
    const geo = {
        init() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(this.onUpdate, this.onError, {
                    enableHighAccuracy: true,
                    maximumAge: 1000
                });
            }
        },
        onUpdate(pos) {
            const { latitude, longitude, altitude } = pos.coords;
            const currentAlt = altitude || 0;
            const ll = [latitude, longitude];
            
            APP_STATE.lastPos = ll;
            document.getElementById('dash-alt').innerText = Math.round(currentAlt);

            // Update Map Marker
            mapManager.updateUserMarker(ll, currentAlt);

            // Breadcrumb Logic (Salvataggio ogni 10 metri)
            if (APP_STATE.history.length === 0 || 
                L.latLng(ll).distanceTo(L.latLng(APP_STATE.history[APP_STATE.history.length-1])) > 10) {
                
                APP_STATE.history.push({lat: latitude, lng: longitude, alt: currentAlt});
                mapManager.breadcrumbLayer.setLatLngs(APP_STATE.history.map(p => [p.lat, p.lng]));
                storage.save('v51_breadcrumb_json', APP_STATE.history);
            }
            
            ui.updateDashboard(ll);
        },
        onError(err) { console.warn(`Errore GPS: ${err.message}`); },
        sendSOS() {
            if(!APP_STATE.lastPos) return alert("Posizione non disponibile");
            const msg = `SOS! Coordinate: ${APP_STATE.lastPos[0].toFixed(6)}, ${APP_STATE.lastPos[1].toFixed(6)}`;
            navigator.clipboard.writeText(msg).then(() => alert("Coordinate SOS copiate negli appunti!"));
        }
    };

    // --- MODULO MAPPA ---
    const mapManager = {
        map: null,
        marker: null,
        gpxLayer: null,
        breadcrumbLayer: null,
        editLine: null,

        init() {
            const std = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
            const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png');
            const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

            this.map = L.map('map', { zoomControl: false, layers: [std] }).setView([45.8, 9.0], 13);
            L.control.layers({"Mappa": std, "Topografica": topo, "Satellite": sat}, null, {position: 'topright'}).addTo(this.map);

            this.breadcrumbLayer = L.polyline([], {color: '#00d2ff', weight: 4, opacity: 0.8}).addTo(this.map);
            this.editLine = L.polyline([], {color: '#2ecc71', weight: 5, dashArray: '10, 10'}).addTo(this.map);

            // Caricamento dati iniziali
            const savedBreadcrumb = storage.load('v51_breadcrumb_json');
            if(savedBreadcrumb) {
                APP_STATE.history = savedBreadcrumb;
                this.breadcrumbLayer.setLatLngs(savedBreadcrumb.map(p => [p.lat, p.lng]));
            }

            const savedPath = localStorage.getItem('v51_saved_path_raw'); // Manteniamo compatibilit√† per caricamento
            if(savedPath) editor.renderPath(savedPath);

            document.getElementById('btn-recenter').onclick = () => {
                if(this.marker) this.map.setView(this.marker.getLatLng(), 16);
            };

            this.map.on('click', e => { if(APP_STATE.isEditing) editor.addPoint(e.latlng); });
        },

        updateUserMarker(ll, alt) {
            const iconHtml = `<div class="user-marker-icon" style="transform: rotate(${APP_STATE.heading}deg)">
                                <img src="https://raw.githubusercontent.com/AlleRock/sua_altezza/main/punto.png" width="40" height="40" onerror="this.src='https://cdn-icons-png.flaticon.com/512/684/684908.png'">
                             </div>`;
            const icon = L.divIcon({ className: '', html: iconHtml, iconSize: [40, 40], iconAnchor: [20, 20] });

            if (!this.marker) this.marker = L.marker(ll, {icon}).addTo(this.map);
            else { this.marker.setLatLng(ll); this.marker.setIcon(icon); }
        }
    };

    // --- MODULO EDITOR PERCORSI ---
    const editor = {
        tempPoints: [],
        start() {
            APP_STATE.isEditing = true;
            ui.toggleToolbox();
            ui.switchPage('map');
            document.getElementById('editor-controls').style.display = 'flex';
        },
        async addPoint(latlng) {
            const last = this.tempPoints[this.tempPoints.length - 1];
            if (last) {
                // Rotte per escursionismo via OSRM
                try {
                    const res = await fetch(`https://router.project-osrm.org/route/v1/hiking/${last.lng},${last.lat};${latlng.lng},${latlng.lat}?geometries=geojson`);
                    const data = await res.json();
                    if (data.routes && data.routes[0]) {
                        const segment = data.routes[0].geometry.coordinates.map(c => L.latLng(c[1], c[0]));
                        mapManager.editLine.setLatLngs(mapManager.editLine.getLatLngs().concat(segment));
                    }
                } catch(e) { mapManager.editLine.addLatLng(latlng); }
            } else {
                mapManager.editLine.addLatLng(latlng);
            }
            this.tempPoints.push(latlng);
        },
        save() {
            const pts = mapManager.editLine.getLatLngs();
            if(pts.length < 2) return alert("Disegna almeno un breve tratto");
            // Nota: Qui potresti convertire in un oggetto JSON strutturato invece di XML GPX per performance
            // Per ora salviamo il set di punti per mantenere la compatibilit√† rendering
            const rawPath = JSON.stringify(pts);
            localStorage.setItem('v51_saved_path_raw', rawPath); 
            // In una versione PRO qui chiameresti un'API di elevazione per arricchire i dati
            location.reload(); 
        },
        undo() {
            const current = mapManager.editLine.getLatLngs();
            current.pop();
            mapManager.editLine.setLatLngs(current);
            this.tempPoints.pop();
        },
        handleFileUpload(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                localStorage.setItem('v51_saved_path_raw', ev.target.result);
                this.renderPath(ev.target.result);
                ui.toggleToolbox();
            };
            reader.readAsText(e.target.files[0]);
        },
        renderPath(data) {
            if (mapManager.gpxLayer) mapManager.map.removeLayer(mapManager.gpxLayer);
            mapManager.gpxLayer = omnivore.gpx.parse(data).on('ready', () => {
                APP_STATE.routePoints = [];
                mapManager.gpxLayer.eachLayer(l => { 
                    if(l.getLatLngs) {
                        l.getLatLngs().forEach(p => APP_STATE.routePoints.push({lat: p.lat, lng: p.lng, alt: p.alt || 0}));
                    }
                });
                ui.updateChart();
                mapManager.map.fitBounds(mapManager.gpxLayer.getBounds());
            }).addTo(mapManager.map);
        }
    };

    // --- MODULO SENSORI ---
    const sensors = {
        initBarometer() {
            if ('PressureSensor' in window) {
                try {
                    const sensor = new PressureSensor({frequency: 1});
                    sensor.addEventListener('reading', () => {
                        document.getElementById('baro-val').innerText = sensor.pressure.toFixed(1);
                    });
                    sensor.start();
                } catch(e) { document.getElementById('baro-error').style.display = 'block'; }
            } else {
                document.getElementById('baro-error').style.display = 'block';
            }
        },
        requestPermissions() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => { if (response === 'granted') this.startCompass(); })
                    .catch(console.error);
            } else {
                this.startCompass();
            }
        },
        startCompass() {
            window.addEventListener('deviceorientation', e => {
                APP_STATE.heading = e.webkitCompassHeading || (360 - e.alpha);
                document.getElementById('compass-rose').style.transform = `rotate(${-APP_STATE.heading}deg)`;
                document.getElementById('degrees').innerText = `${Math.round(APP_STATE.heading)}¬∞`;
            });
        }
    };

    // --- MODULO UI & CHART ---
    let altChartInstance = null;
    const ui = {
        init() {
            this.initChart();
            setTimeout(() => {
                const s = document.getElementById('splash-screen');
                s.style.opacity = '0';
                setTimeout(() => s.style.display = 'none', 800);
            }, 3000);
        },
        switchPage(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+p).classList.add('active');
            if(p === 'map') setTimeout(() => mapManager.map.invalidateSize(), 300);
        },
        toggleToolbox() {
            const p = document.getElementById('toolbox-panel');
            p.style.display = (p.style.display === 'block') ? 'none' : 'block';
        },
        initChart() {
            const ctx = document.getElementById('altChart').getContext('2d');
            altChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Profilo', data: [], borderColor: '#f1c40f', backgroundColor: 'rgba(241,196,15,0.1)', fill: true, pointRadius: 0, borderWidth: 2 },
                        { label: 'Tu', data: [], pointRadius: 6, pointBackgroundColor: '#ff4757', showLine: false }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } }
                    }
                }
            });
        },
        updateChart() {
            if(!altChartInstance || APP_STATE.routePoints.length === 0) return;
            altChartInstance.data.labels = APP_STATE.routePoints.map((_, i) => i);
            altChartInstance.data.datasets[0].data = APP_STATE.routePoints.map(p => p.alt);
            altChartInstance.update();
        },
        updateDashboard(ll) {
            // Calcolo KM fatti e D+ fatto
            let distDone = 0, gainDone = 0;
            for(let i=1; i < APP_STATE.history.length; i++) {
                distDone += L.latLng(APP_STATE.history[i-1]).distanceTo(L.latLng(APP_STATE.history[i]));
                let diff = APP_STATE.history[i].alt - APP_STATE.history[i-1].alt;
                if(diff > 0) gainDone += diff;
            }
            document.getElementById('dash-done').innerText = (distDone/1000).toFixed(1);
            document.getElementById('dash-up-done').innerText = Math.round(gainDone);

            // Calcolo residui se c'√® un percorso
            if (APP_STATE.routePoints.length > 0) {
                let minDist = Infinity, closestIdx = 0;
                APP_STATE.routePoints.forEach((p, i) => {
                    let d = L.latLng(ll).distanceTo(L.latLng(p.lat, p.lng));
                    if(d < minDist) { minDist = d; closestIdx = i; }
                });

                // Update cursore su grafico
                altChartInstance.data.datasets[1].data = APP_STATE.routePoints.map((_, i) => i === closestIdx ? APP_STATE.routePoints[i].alt : null);
                altChartInstance.update('none');

                let distRem = 0, gainRem = 0;
                for(let i = closestIdx; i < APP_STATE.routePoints.length - 1; i++) {
                    distRem += L.latLng(APP_STATE.routePoints[i]).distanceTo(L.latLng(APP_STATE.routePoints[i+1]));
                    let diff = APP_STATE.routePoints[i+1].alt - APP_STATE.routePoints[i].alt;
                    if(diff > 0) gainRem += diff;
                }
                document.getElementById('dash-todo').innerText = (distRem/1000).toFixed(1);
                document.getElementById('dash-up-todo').innerText = Math.round(gainRem);
            }
        }
    };

    // Avvio del sistema
    window.onload = () => {
        ui.init();
        mapManager.init();
        geo.init();
        sensors.initBarometer();
    };
    </script>
</body>
</html>
