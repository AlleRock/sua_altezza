<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sua Altezza - Mem Software</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&family=Barlow+Condensed:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --gold: #f1c40f; --bg: #0b0f1a; --card-bg: rgba(255, 255, 255, 0.08);
            --danger: #ff4757; --success: #2ecc71; --tab-bg: #161b2a; --text: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow: hidden; height: 100vh; }
        
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0b0f1a; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
            transition: opacity 1s ease, visibility 1s;
        }

        .page { display: none; height: calc(100vh - 75px); width: 100%; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .page.active { display: block; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .card { background: var(--card-bg); border: 1px solid var(--gold); border-radius: 12px; padding: 8px; text-align: center; }
        .card-label { font-size: 0.55rem; color: #64748b; text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }
        .value { font-family: 'Barlow Condensed'; font-size: 1.5rem; font-weight: 800; color: var(--gold); line-height: 1.1; }

        .compass-area { position: relative; width: 120px; height: 120px; margin: 5px auto; display: flex; align-items: center; justify-content: center; }
        .compass-housing { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid rgba(255,255,255,0.1); background: radial-gradient(circle, #1a1f2e 0%, #0b0f1a 100%); }
        #compass-rose { width: 85%; height: 85%; transition: transform 0.1s linear; z-index: 2; }
        .fixed-pointer { position: absolute; top: -5px; width: 4px; height: 15px; background: var(--gold); z-index: 10; border-radius: 2px; }
        .degrees-display { position: absolute; font-family: 'Barlow Condensed'; font-size: 1.1rem; font-weight: 800; z-index: 5; top: 52%; }

        .chart-box { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 10px; height: 100px; margin-top: 5px; }

        #toolbox-panel { position: fixed; bottom: 85px; left: 15px; right: 15px; background: var(--tab-bg); border: 2px solid var(--gold); border-radius: 20px; padding: 20px; display: none; z-index: 3000; max-height: 70vh; overflow-y: auto; }
        
        #download-box { display: none; background: rgba(46, 204, 113, 0.1); padding: 10px; border-radius: 12px; margin-bottom: 10px; border: 1px dashed var(--success); }
        .progress-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin: 5px 0; }
        #progress-bar { width: 0%; height: 100%; background: var(--success); }

        button { font-family: 'Inter'; font-weight: 700; border-radius: 12px; border: none; text-transform: uppercase; cursor: pointer; width: 100%; padding: 12px; margin-bottom: 6px; font-size: 0.75rem; }
        .btn-sensor { background: var(--gold); color: black; }
        .btn-sos { background: var(--danger); color: white; border: 1px solid white; }
        .btn-white { background: white; color: black; }
        .btn-offline { background: var(--success); color: black; }
        .btn-progetto { background: #8e44ad; color: white; }

        /* EDITOR UI */
        #editor-info { 
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); padding: 10px 20px; border-radius: 30px;
            border: 2px solid var(--success); z-index: 2000; display: none;
            text-align: center; width: 80%; pointer-events: none;
        }
        #editor-controls {
            position: absolute; bottom: 20px; left: 10px; right: 10px;
            display: none; z-index: 2000; gap: 10px;
        }

        .map-overlay-btn { 
            position: absolute; bottom: 20px; right: 20px; 
            width: 50px; height: 50px; background: var(--tab-bg); 
            border: 2px solid var(--gold); border-radius: 50%; 
            z-index: 1000; display: flex; align-items: center; 
            justify-content: center; font-size: 1.5rem; color: var(--gold);
        }

        /* METEO STYLE */
        .meteo-hero { text-align: center; margin-top: 50px; }
        .pressure-val { font-size: 4rem; font-family: 'Barlow Condensed'; font-weight: 800; color: var(--success); }
        .storm-alert { background: rgba(255, 71, 87, 0.2); border: 2px solid var(--danger); padding: 15px; border-radius: 15px; margin-top: 20px; display: none; }

        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--tab-bg); display: flex; align-items: center; z-index: 2000; border-top: 1px solid rgba(255,255,255,0.05); }
        .tab-item { text-align: center; color: #4b5563; flex: 1; font-size: 0.65rem; font-weight: 700; }
        .tab-item.active { color: var(--gold); }
        .tab-item span { font-size: 1.5rem; display: block; }
        #map { height: 100%; width: 100%; background: #000; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <h1 style="color:var(--gold); font-weight:900; margin:0; font-size:2.5rem;">SUA ALTEZZA</h1>
        <div style="color:#64748b; letter-spacing:3px; font-size:0.8rem;">SISTEMI DI NAVIGAZIONE REALI</div>
        <div style="margin-top:40px; color:rgba(255,255,255,0.3); font-size:0.7rem;">Designed by <b>Mem Software</b></div>
    </div>

    <div id="page-dash" class="page active">
        <div class="stats-grid">
            <div class="card"><div class="card-label">Quota</div><div id="dash-alt" class="value">--</div></div>
            <div class="card"><div class="card-label">Pendenza</div><div id="dash-slope" class="value">0%</div></div>
        </div>
        <div class="stats-grid">
            <div class="card"><div class="card-label">Km Fatti</div><div id="dash-done" class="value">0.0</div></div>
            <div class="card"><div class="card-label">Km Restanti</div><div id="dash-todo" class="value">--</div></div>
        </div>
        <div class="stats-grid">
            <div class="card" style="border-color: var(--success);"><div class="card-label">D+ Fatto</div><div id="dash-up-done" class="value">0</div></div>
            <div class="card" style="border-color: var(--danger);"><div class="card-label">D+ Restante</div><div id="dash-up-todo" class="value">--</div></div>
        </div>

        <div class="compass-area">
            <div class="compass-housing"></div>
            <div class="fixed-pointer"></div>
            <svg id="compass-rose" viewBox="0 0 200 200">
                <text x="100" y="32" fill="#f1c40f" font-family="Barlow Condensed" font-size="28" text-anchor="middle" font-weight="900">N</text>
                <text x="100" y="185" fill="#fff" font-family="Barlow Condensed" font-size="22" text-anchor="middle">S</text>
            </svg>
            <div id="degrees" class="degrees-display">0¬∞</div>
        </div>

        <div class="chart-box"><canvas id="altChart"></canvas></div>

        <button id="sensor-btn" class="btn-sensor" style="margin-top:10px;" onclick="requestSensorPermission()">üß≠ ATTIVA BUSSOLA</button>
        <button class="btn-white" onclick="toggleToolbox()">üß∞ TOOLBOX</button>

        <div id="download-box">
            <div id="status-text" style="font-size:0.7rem; color:var(--success); font-weight:700; text-align:center;">Scarico...</div>
            <div class="progress-bg"><div id="progress-bar"></div></div>
        </div>
    </div>

    <div id="toolbox-panel">
        <h3 style="text-align:center; color:var(--gold); margin-top:0;">TOOLBOX</h3>
        <button class="btn-progetto" onclick="startEditor()">‚úçÔ∏è PROGETTA ITINERARIO</button>
        <button class="btn-sos" onclick="sendSOS()">üö® SOS COORDINATE (SMS)</button>
        <button class="btn-white" onclick="checkSensors()">üîç CHECK-UP SENSORI</button>
        <button class="btn-white" onclick="alert('Foto Overlay: In sviluppo')">üì∏ FOTO OVERLAY DATI</button>
        <button class="btn-white" onclick="document.getElementById('gpx-input').click()">üó∫Ô∏è CARICA GPX</button>
        <button class="btn-offline" onclick="downloadMapArea()">üíæ SALVA MAPPA OFFLINE</button>
        <button class="btn-white" style="background:#444; color:white" onclick="clearBreadcrumbs()">üóëÔ∏è CANCELLA TRACCIA</button>
        <button class="btn-white" style="background:#222; color:white" onclick="toggleToolbox()">CHIUDI</button>
        <input type="file" id="gpx-input" style="display:none" onchange="handleFileSelect(event)">
    </div>

    <div id="page-map" class="page" style="padding:0; position:relative;">
        <div id="editor-info">
            <div style="color:var(--success); font-weight:900; font-size:0.8rem;">MODALIT√Ä PROGETTO</div>
            <div id="edit-stats" style="font-size:0.7rem; color:white;">Tocca i sentieri sulla mappa</div>
        </div>
        <div id="map"></div>
        <div id="editor-controls">
            <button class="btn-white" style="flex:1" onclick="undoEditor()">ANNULLA</button>
            <button class="btn-success" style="flex:2" onclick="saveEditor()">SALVA PERCORSO</button>
        </div>
        <div id="map-center-btn" class="map-overlay-btn" onclick="centerOnMe()">üéØ</div>
    </div>

    <div id="page-meteo" class="page">
        <div class="meteo-hero">
            <div class="card-label">Pressione Atmosferica</div>
            <div id="baro-val" class="pressure-val">--</div>
            <div style="color:#64748b; font-weight:700;">hPa</div>
            <div id="meteo-alert" class="storm-alert">
                <div style="font-weight:900;">‚ö†Ô∏è ALLERTA TEMPORALE</div>
                <div style="font-size:0.7rem;">Crollo pressione rilevato!</div>
            </div>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" id="tab-dash" onclick="switchPage('dash')"><span>üìä</span>HOME</div>
        <div class="tab-item" id="tab-map" onclick="switchPage('map')"><span>üó∫Ô∏è</span>MAPPA</div>
        <div class="tab-item" id="tab-meteo" onclick="switchPage('meteo')"><span>‚òÅÔ∏è</span>METEO</div>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js"></script>

    <script>
        let map, marker, gpxLayer, breadcrumbLayer, altChart;
        let myHistory = [], gpxPoints = [], editorPoints = [], editorMarkers = [], pressureLog = [];
        let isEditing = false, editLine;

        setTimeout(() => {
            const s = document.getElementById('splash-screen');
            s.style.opacity = '0';
            setTimeout(() => s.style.visibility = 'hidden', 1000);
        }, 3000);

        function initApp() {
            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
            const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png');
            const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

            map = L.map('map', { zoomControl: false, layers: [osm] }).setView([45.0, 7.0], 13);
            L.control.layers({"Standard": osm, "Topografica": topo, "Satellite": sat}, null, {position: 'topright'}).addTo(map);

            breadcrumbLayer = L.polyline([], {color: '#00d2ff', weight: 4, dashArray: '5, 8'}).addTo(map);
            editLine = L.polyline([], {color: '#2ecc71', weight: 5, dashArray: '10, 10'}).addTo(map);

            if (localStorage.getItem('my_breadcrumb_json')) {
                myHistory = JSON.parse(localStorage.getItem('my_breadcrumb_json'));
                breadcrumbLayer.setLatLngs(myHistory);
            }
            if (localStorage.getItem('saved_path_json')) renderGPX(localStorage.getItem('saved_path_json'));

            navigator.geolocation.watchPosition(updatePos, null, { enableHighAccuracy: true });
            initChart();
            startBarometer();

            map.on('click', function(e) { if(isEditing) addEditorPoint(e.latlng); });
        }

        // --- EDITOR ---
        function startEditor() {
            isEditing = true; toggleToolbox(); switchPage('map');
            document.getElementById('editor-info').style.display = 'block';
            document.getElementById('editor-controls').style.display = 'flex';
            document.getElementById('map-center-btn').style.display = 'none';
            editorPoints = []; editorMarkers.forEach(m => map.removeLayer(m)); editorMarkers = []; editLine.setLatLngs([]);
        }

        async function addEditorPoint(latlng) {
            const lastPoint = editorPoints[editorPoints.length - 1];
            let newSegment = [latlng];
            if (lastPoint) {
                try {
                    const res = await fetch(`https://router.project-osrm.org/route/v1/foot/${lastPoint.lng},${lastPoint.lat};${latlng.lng},${latlng.lat}?geometries=geojson`);
                    const data = await res.json();
                    if (data.routes.length > 0) newSegment = data.routes[0].geometry.coordinates.map(c => L.latLng(c[1], c[0]));
                } catch (e) {}
            }
            editorPoints.push(latlng);
            const m = L.circleMarker(latlng, {radius: 6, color: '#2ecc71', fillOpacity: 1}).addTo(map);
            editorMarkers.push(m);
            editLine.setLatLngs(editLine.getLatLngs().concat(newSegment));
            updateEditorStats();
        }

        function updateEditorStats() {
            let d = 0; const pts = editLine.getLatLngs();
            for(let i=1; i<pts.length; i++) d += pts[i-1].distanceTo(pts[i]);
            document.getElementById('edit-stats').innerText = `${(d/1000).toFixed(2)} km | Punti: ${editorPoints.length}`;
        }

        function undoEditor() {
            if (editorPoints.length > 0) {
                editorPoints.pop(); map.removeLayer(editorMarkers.pop());
                if (editorPoints.length === 0) editLine.setLatLngs([]);
                updateEditorStats();
            }
        }

        function saveEditor() {
            const coords = editLine.getLatLngs();
            if (coords.length < 2) return alert("Pochi punti!");
            const fakeGPX = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1"><trk><trkseg>` + 
                coords.map(c => `<trkpt lat="${c.lat}" lon="${c.lng}"><ele>0</ele></trkpt>`).join('') + 
                `</trkseg></trk></gpx>`;
            localStorage.setItem('saved_path_json', fakeGPX);
            renderGPX(fakeGPX);
            exitEditor();
        }

        function exitEditor() {
            isEditing = false;
            document.getElementById('editor-info').style.display = 'none';
            document.getElementById('editor-controls').style.display = 'none';
            document.getElementById('map-center-btn').style.display = 'flex';
            editorMarkers.forEach(m => map.removeLayer(m));
            editLine.setLatLngs([]);
            switchPage('dash');
        }

        // --- METEO ---
        function startBarometer() {
            if ('PressureSensor' in window) {
                const s = new PressureSensor({frequency: 1});
                s.addEventListener('reading', () => {
                    const p = s.pressure.toFixed(1);
                    document.getElementById('baro-val').innerText = p;
                    pressureLog.push({t: Date.now(), v: p});
                    pressureLog = pressureLog.filter(x => Date.now() - x.t < 10800000);
                    if(pressureLog.length > 10 && (pressureLog[0].v - p) > 2) document.getElementById('meteo-alert').style.display = 'block';
                });
                s.start();
            }
        }

        // --- CORE ---
        function updatePos(pos) {
            const latlng = [pos.coords.latitude, pos.coords.longitude];
            const alt = pos.coords.altitude || 0;
            document.getElementById('dash-alt').innerText = alt.toFixed(0);
            if (!marker) {
                marker = L.marker(latlng, { icon: L.icon({ iconUrl: "https://raw.githubusercontent.com/AlleRock/sua_altezza/main/punto.png", iconSize: [45, 45] }) }).addTo(map);
                map.setView(latlng, 16);
            } else marker.setLatLng(latlng);
            
            if (myHistory.length === 0 || L.latLng(latlng).distanceTo(L.latLng(myHistory[myHistory.length-1])) > 5) {
                myHistory.push({lat: latlng[0], lng: latlng[1], alt: alt});
                breadcrumbLayer.setLatLngs(myHistory);
                localStorage.setItem('my_breadcrumb_json', JSON.stringify(myHistory));
                updateStats(latlng);
            }
        }

        function updateStats(ll) {
            let gain = 0;
            for(let i=1; i<myHistory.length; i++) {
                let d = myHistory[i].alt - myHistory[i-1].alt;
                if(d > 0) gain += d;
            }
            document.getElementById('dash-up-done').innerText = Math.round(gain);
            document.getElementById('dash-done').innerText = (myHistory.length * 0.005).toFixed(1);
            
            if(gpxPoints.length > 0) {
                let minDist = Infinity, idx = 0;
                gpxPoints.forEach((p, i) => {
                    let d = L.latLng(ll).distanceTo(L.latLng(p.lat, p.lon));
                    if(d < minDist) { minDist = d; idx = i; }
                });
                let dRem = 0;
                for(let i=idx; i<gpxPoints.length-1; i++) dRem += L.latLng(gpxPoints[i].lat, gpxPoints[i].lon).distanceTo(L.latLng(gpxPoints[i+1].lat, gpxPoints[i+1].lon));
                document.getElementById('dash-todo').innerText = (dRem/1000).toFixed(1);
            }
        }

        function sendSOS() {
            const ll = marker.getLatLng();
            const msg = `SOS! Posizione: http://maps.google.com/maps?q=${ll.lat},${ll.lng} (Quota: ${document.getElementById('dash-alt').innerText}m)`;
            navigator.clipboard.writeText(msg).then(() => alert("SOS COPIATO!"));
        }

        async function downloadMapArea() {
            if (!gpxLayer) return alert("Carica un GPX!");
            const box = document.getElementById('download-box'), bar = document.getElementById('progress-bar');
            box.style.display = 'block';
            const bounds = gpxLayer.getBounds(), cache = await caches.open('map-v43'), zooms = [14, 15];
            let urls = [];
            zooms.forEach(z => {
                const nw = map.project(bounds.getNorthWest(), z).divideBy(256).floor(), se = map.project(bounds.getSouthEast(), z).divideBy(256).floor();
                for (let x = nw.x; x <= se.x; x++) for (let y = nw.y; y <= se.y; y++) urls.push(`https://a.tile.openstreetmap.org/${z}/${x}/${y}.png`);
            });
            for (let i = 0; i < urls.length; i++) {
                try { await fetch(urls[i]).then(r => cache.put(urls[i], r)); } catch (e) {}
                bar.style.width = Math.round(((i+1)/urls.length)*100) + "%";
            }
            alert("Mappa Offline Salvata!"); box.style.display = 'none';
        }

        function renderGPX(data) {
            if (gpxLayer) map.removeLayer(gpxLayer);
            gpxLayer = omnivore.gpx.parse(data).on('ready', () => {
                gpxPoints = [];
                gpxLayer.eachLayer(l => { if(l.getLatLngs) l.getLatLngs().forEach(p => gpxPoints.push({lat: p.lat, lon: p.lng, alt: p.alt || 0})); });
                altChart.data.datasets[0].data = gpxPoints.map(p => p.alt);
                altChart.update();
                map.fitBounds(gpxLayer.getBounds());
            }).addTo(map);
        }

        function initChart() {
            altChart = new Chart(document.getElementById('altChart'), {
                type: 'line',
                data: { labels: new Array(100).fill(''), datasets: [{ data: [], borderColor: '#f1c40f', pointRadius: 0, fill: true, backgroundColor: 'rgba(241,196,15,0.1)' }] },
                options: { maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { x: {display: false}, y: {ticks: {color: '#666', size: 9}} } }
            });
        }

        function centerOnMe() { if (marker) map.setView(marker.getLatLng(), 17); }

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + p).classList.add('active');
            if(p === 'map') setTimeout(() => map.invalidateSize(), 300);
        }

        function toggleToolbox() {
            const p = document.getElementById('toolbox-panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        }

        function requestSensorPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(r => { if(r==='granted') window.addEventListener('deviceorientation', hOrient); });
            } else window.addEventListener('deviceorientation', hOrient);
            document.getElementById('sensor-btn').style.background = "var(--success)";
        }

        function hOrient(e) {
            let h = e.webkitCompassHeading || (360 - e.alpha);
            document.getElementById('compass-rose').style.transform = `rotate(${-h}deg)`;
            document.getElementById('degrees').innerText = Math.round(h) + "¬∞";
        }

        function checkSensors() { alert(`CHECK-UP:\nGPS: ¬±${marker ? 'OK' : 'Attesa...'}\nBussola: ${window.DeviceOrientationEvent ? 'OK' : 'N.D.'}\nBarometro: ${('PressureSensor' in window) ? 'OK' : 'N.D.'}`); }

        function handleFileSelect(e) {
            const reader = new FileReader();
                reader.onload = (ev) => { localStorage.setItem('saved_path_json', ev.target.result); renderGPX(ev.target.result); toggleToolbox(); };
                reader.readAsText(e.target.files[0]);
        }

        function clearBreadcrumbs() { if(confirm("Cancella traccia?")) { myHistory = []; breadcrumbLayer.setLatLngs([]); localStorage.removeItem('my_breadcrumb_json'); } }

        window.onload = initApp;
    </script>
</body>
</html>
